<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>TAIM HAWASLY | ENTERPRISE OS v19.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
        :root { --bg: #010409; --text: #ffffff; --card: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.1); }
        .light-mode { --bg: #f8fafc; --text: #0f172a; --card: #ffffff; --border: rgba(0,0,0,0.1); }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); transition: 0.3s; margin: 0; overflow: hidden; }
        .full-screen { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        .glass-ui { background: var(--card); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .chat-area { flex: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .msg { background: var(--card); border: 1px solid var(--border); padding: 1.5rem; border-radius: 1.5rem; max-width: 80%; line-height: 1.8; word-wrap: break-word; }
        .user-msg { background: #2563eb; color: white; align-self: flex-end; }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #2563eb; border-radius: 10px; }
    </style>
</head>
<body class="full-screen" id="mainBody">

    <header class="glass-ui p-5 flex justify-between items-center z-20">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/30"><i class="fas fa-crown text-white"></i></div>
            <div>
                <h1 class="text-lg font-black tracking-tight">TAIM HAWASLY</h1>
                <p class="text-[8px] text-blue-500 font-bold uppercase">Enterprise Intelligence v19.0</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleTheme()" class="p-2 rounded-lg bg-white/5 border border-white/10 hover:bg-blue-600 transition"><i id="tIcon" class="fas fa-moon"></i></button>
            <select id="mId" class="bg-black/40 text-[10px] rounded-lg border border-white/10 p-2 text-white outline-none">
                <option value="gemma2:2b">Gemma 2</option>
                <option value="qwen2.5:3b">Qwen 2.5</option>
            </select>
        </div>
    </header>

    <main id="display" class="chat-area custom-scroll"></main>

    <footer class="p-6 bg-black/10">
        <div class="max-w-5xl mx-auto flex gap-3">
            <input type="text" id="userInput" class="flex-1 bg-white/5 border border-white/10 rounded-xl p-4 outline-none focus:ring-2 ring-blue-500/50 text-sm text-inherit" placeholder="اسأل نظامك يا بشمهندس تيم...">
            <button onclick="executeAction()" class="bg-blue-600 px-8 rounded-xl hover:bg-blue-500 transition-all shadow-lg"><i class="fas fa-paper-plane text-white"></i></button>
        </div>
    </footer>

    <script>
        const display = document.getElementById('display');
        const userInput = document.getElementById('userInput');

        function toggleTheme() {
            document.getElementById('mainBody').classList.toggle('light-mode');
            document.getElementById('tIcon').classList.toggle('fa-sun');
            document.getElementById('tIcon').classList.toggle('fa-moon');
        }

        async function getWiki(q) {
            try {
                let sQ = q.replace(/عمر|كم|ما هو|شو هو|فنان/g, "").trim();
                if(q.includes('بحر')) sQ = "قائمة البحار حسب المساحة";
                const r = await fetch(`https://ar.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(sQ)}`);
                const d = await r.json();
                return d.extract || null;
            } catch(e) { return null; }
        }

        async function executeAction() {
            const val = userInput.value.trim();
            if(!val) return;

            renderMsg('user', val);
            userInput.value = ''; // تصفير حقل الإدخال فوراً

            const aiId = renderMsg('ai', 'جاري تحليل البيانات...');
            const aiBox = document.getElementById(aiId);

            const wikiData = await getWiki(val);

            try {
                const response = await fetch('http://127.0.0.1:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: document.getElementById('mId').value,
                        messages: [
                            {role: "system", content: "أنت مساعد تيم حواصلي. تيم مهندس وصاحب شركة. ممنوع تقول البحر الأحمر هو الأكبر. بحر الفلبين هو الأكبر مساحة (5.7 مليون كم). إذا سألك عن عمر تيم حسن فهو 50 عاماً (مواليد 1976). استخدم هذا النص: " + (wikiData || "")},
                            {role: "user", content: val}
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                let fullTxt = "";
                aiBox.innerText = ""; // تفريغ صندوق الإجابة ليبدأ الموديل بالكتابة فيه

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.trim()) {
                            try {
                                const json = JSON.parse(line);
                                if (json.message) {
                                    fullTxt += json.message.content;
                                    aiBox.innerText = fullTxt; // الكتابة في صندوق الدردشة وليس المدخل
                                    display.scrollTo({ top: display.scrollHeight });
                                }
                            } catch(e) {}
                        }
                    }
                }
            } catch (err) { aiBox.innerText = "سيدي المهندس، تأكد من تشغيل Ollama."; }
        }

        function renderMsg(role, text) {
            const id = 'id-' + Date.now();
            const isU = role === 'user';
            const div = document.createElement('div');
            div.className = `flex ${isU ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `<div class="msg ${isU ? 'user-msg' : ''}">
                <p class="text-[7px] font-black opacity-40 mb-1 uppercase tracking-widest">${isU ? 'Founder Taim' : 'Verified Node'}</p>
                <div id="${id}" class="text-sm">${text}</div>
            </div>`;
            display.appendChild(div);
            display.scrollTo({ top: display.scrollHeight, behavior: 'smooth' });
            return id;
        }

        userInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') executeAction(); });
    </script>
</body>
</html>